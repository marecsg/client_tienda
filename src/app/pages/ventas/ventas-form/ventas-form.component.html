<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Nueva Venta</h3>
    <button class="btn btn-secondary" (click)="volver()">Volver</button>
  </div>

  <!-- Formulario de datos principales -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <label class="form-label">Cliente</label>
          <select class="form-select" [(ngModel)]="venta.clienteId" name="cliente">
            <option [ngValue]="null">-- Seleccionar --</option>
            <option *ngFor="let c of clientes" [ngValue]="c.id">
              {{ c.nombres }} (DNI: {{ c.dni }})
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Fecha</label>
          <input type="datetime-local" class="form-control" [(ngModel)]="venta.fecha" name="fecha">
        </div>
      </div>
    </div>
  </div>

  <!-- Detalle de la venta -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Detalle de productos</span>
      <button class="btn btn-sm btn-outline-success" (click)="addDetalle()">
        + Agregar producto
      </button>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th style="width: 120px;">Cantidad</th>
            <th style="width: 150px;">Precio Unit.</th>
            <th style="width: 80px;">Importe</th>
            <th style="width: 70px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of venta.detalles; let i = index">
            <td>
              <select class="form-select" [(ngModel)]="d.productoId" (change)="onProductoChange(d)"
                name="producto{{i}}">
                <option [ngValue]="0">-- Seleccionar --</option>
                <option *ngFor="let p of productos" [ngValue]="p.id">
                  {{ p.nombre }} (S/ {{ p.precio }})
                </option>
              </select>
            </td>
            <td>
              <input type="number" class="form-control" [(ngModel)]="d.cantidad" name="cantidad{{i}}" min="1">
            </td>
            <td>
              <input type="number" class="form-control" [(ngModel)]="d.precioUnitario" name="precio{{i}}" step="0.01"
                min="0">
            </td>
            <td>
              S/ {{ (d.cantidad * d.precioUnitario) || 0 | number:'1.2-2' }}
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-danger" (click)="removeDetalle(i)"
                *ngIf="venta.detalles.length > 1">
                ✕
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="d-flex justify-content-end">
        <h5>Total: <span class="badge bg-primary">S/ {{ total | number:'1.2-2' }}</span></h5>
      </div>
    </div>
  </div>

  <!-- Botones -->
  <div class="d-flex justify-content-end mb-4">
    <button class="btn btn-primary" (click)="guardarVenta()">
      Registrar venta
    </button>
  </div>

  <!-- Boleta / comprobante -->
<div class="card mt-4" *ngIf="ventaCreada" id="boleta">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Boleta / Comprobante</span>
      <button class="btn btn-sm btn-outline-dark" (click)="imprimirBoleta()">Imprimir</button>
    </div>
    <div class="card-body">
      <p><strong>N° Venta:</strong> {{ ventaCreada.id }}</p>
      <p><strong>Fecha:</strong> {{ ventaCreada.fecha | date:'short' }}</p>
      <p><strong>Cliente:</strong>
        {{ ventaCreada ? getClienteDescripcion(ventaCreada.clienteId) : '' }}
      </p>
      <hr>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unit.</th>
            <th>Importe</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of ventaCreada.detalles">
            <td>{{ getProductoNombre(d.productoId) }}</td>
            <td>{{ d.cantidad }}</td>
            <td>S/ {{ d.precioUnitario | number:'1.2-2' }}</td>
            <td>S/ {{ d.cantidad * d.precioUnitario | number:'1.2-2' }}</td>
          </tr>
        </tbody>
      </table>
      <div class="text-end">
        <h5>Total: <strong>S/ {{ ventaCreada.total | number:'1.2-2' }}</strong></h5>
      </div>

      <hr>
      <div class="row g-2">
        <div class="col-md-5">
          <input type="email" class="form-control" [(ngModel)]="correoEnvio"
            placeholder="Correo para enviar comprobante">
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-primary w-100" (click)="enviarComprobanteEmail()">
            Enviar correo
          </button>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" [(ngModel)]="numeroEnvio" placeholder="Número (WhatsApp/SMS)">
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-success w-100" (click)="enviarComprobanteNumero()">
            Enviar número
          </button>
        </div>
      </div>
    </div>
  </div>
</div>